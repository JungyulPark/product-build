<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Personality Analysis Result | KStar Match</title>
  <meta name="description" content="Your personalized Korean personality analysis results. Discover your Four Pillars profile, personality insights, career paths, and compatibility.">
  <meta name="keywords" content="personality analysis result, ì„±ê²© ê²°ê³¼, Four Pillars profile, KStar Match">
  <meta name="author" content="KStar Match">
  <meta name="robots" content="noindex, follow">

  <!-- Canonical URL -->
  <link rel="canonical" href="https://kfortunes.com/result.html">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="KStar Match">
  <meta property="og:title" content="My KStar Match Personality Profile">
  <meta property="og:description" content="Discover your personality with KStar Match - Korean Four Pillars personality analysis">
  <meta property="og:image" content="https://kfortunes.com/sajucharacter.webp">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="https://kfortunes.com/result.html">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="My KStar Match Personality Profile">
  <meta name="twitter:description" content="Check out my Korean personality analysis!">
  <meta name="twitter:image" content="https://kfortunes.com/sajucharacter.webp">

  <meta name="google-adsense-account" content="ca-pub-8992259838992521">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>â­</text></svg>">
  <link href="style.css" rel="stylesheet">

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y36C26EGSG"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-Y36C26EGSG');
  </script>
  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8992259838992521" crossorigin="anonymous"></script>
  <!-- Microsoft Clarity -->
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "v2s96lo21z");
  </script>

  <style>
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 0.5s, visibility 0.5s;
    }

    .loading-overlay.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .loading-spinner {
      width: 80px;
      height: 80px;
      border: 4px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      margin-top: 2rem;
      font-size: 1.2rem;
      color: var(--text-secondary);
      text-align: center;
    }

    .loading-text .highlight {
      color: var(--accent-light);
      display: block;
      margin-top: 0.5rem;
      font-size: 1rem;
    }

    .loading-progress {
      width: 200px;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 1.5rem;
      overflow: hidden;
    }

    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-pink));
      animation: progress 2s ease-in-out;
    }

    @keyframes progress {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }

    /* Celebrity Match Card */
    .celebrity-match {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 12px;
      margin-bottom: 1rem;
    }

    .celebrity-icon {
      font-size: 2.5rem;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--accent), var(--accent-pink));
      border-radius: 50%;
    }

    .celebrity-info {
      flex: 1;
    }

    .celebrity-name {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .celebrity-korean {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .celebrity-category {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      background: rgba(139, 92, 246, 0.2);
      border-radius: 4px;
      font-size: 0.75rem;
      color: var(--accent-light);
      margin-top: 0.25rem;
    }

    .match-message {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-top: 1rem;
      padding: 1rem;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));
      border-radius: 8px;
      border-left: 3px solid var(--accent);
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">
      Analyzing your personality profile...
      <span class="highlight">Building your personality profile</span>
    </div>
    <div class="loading-progress">
      <div class="loading-progress-bar"></div>
    </div>
  </div>

  <header>
    <div class="header-content">
      <a href="/" class="logo">KStar Match</a>
      <nav>
        <a href="index.html">New Analysis</a>
        <a href="compatibility.html">Compatibility</a>
        <a href="about.html">About</a>
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
          <span class="icon-sun">â˜€ï¸</span>
          <span class="icon-moon">ğŸŒ™</span>
        </button>
      </nav>
    </div>
  </header>

  <main>
    <section class="result-header">
      <div class="badge">âœ¨ Your Personality Profile</div>
      <h1>Your <span class="gradient-text">Personality</span> Revealed</h1>
      <p class="subtitle">Birth Date: <span id="birth-info">Loading...</span></p>
      <p style="margin-top: 0.5rem; color: var(--accent-light);">
        Day Master: <span id="day-master">Loading...</span>
      </p>
    </section>

    <!-- ì‚¬ì£¼íŒ”ì ì°¨íŠ¸ -->
    <div class="card" style="margin-bottom: 1.5rem;">
      <h3 style="text-align: center; margin-bottom: 1.5rem;">ğŸ›ï¸ Four Pillars (å››æŸ±)</h3>
      <div class="pillars-chart" id="pillars-chart">
        <div class="pillar"><div class="pillar-label">Loading...</div></div>
      </div>
    </div>

    <!-- ì˜¤í–‰ ë¶„ì„ -->
    <div class="section-card">
      <h3>â˜¯ï¸ Five Elements Balance</h3>
      <div id="element-chart">
        <p style="color: var(--text-secondary);">Analyzing elements...</p>
      </div>
    </div>

    <!-- K-Star Personality Twin Section -->
    <div class="kstar-twin-section" id="kstar-twin-section">
      <div class="kstar-twin-badge">ğŸŒŸ My K-Star Personality Twin</div>
      <h2 class="kstar-twin-title">Which K-Star Matches Your Personality?</h2>

      <div class="kstar-twin-card" id="kstar-twin-card">
        <div class="twin-loading">
          <div class="twin-spinner"></div>
          <p>Finding your K-Star Twin...</p>
        </div>
      </div>

      <!-- Share Buttons -->
      <div class="kstar-share-buttons" id="kstar-share-buttons" style="display: none;">
        <button class="btn-save-image" onclick="saveKStarTwinAsImage()">
          ğŸ“¸ Save as Image
        </button>
        <p class="share-prompt">ğŸ”¥ Share with your friends!</p>
        <div class="share-btn-grid">
          <button class="kstar-share-btn twitter" onclick="shareKStarTwin('twitter')">
            <span class="btn-icon">ğ•</span>
            <span>Twitter</span>
          </button>
          <button class="kstar-share-btn facebook" onclick="shareKStarTwin('facebook')">
            <span class="btn-icon">ğŸ“˜</span>
            <span>Facebook</span>
          </button>
          <button class="kstar-share-btn whatsapp" onclick="shareKStarTwin('whatsapp')">
            <span class="btn-icon">ğŸ’¬</span>
            <span>WhatsApp</span>
          </button>
          <button class="kstar-share-btn telegram" onclick="shareKStarTwin('telegram')">
            <span class="btn-icon">âœˆï¸</span>
            <span>Telegram</span>
          </button>
          <button class="kstar-share-btn line" onclick="shareKStarTwin('line')">
            <span class="btn-icon">ğŸ’š</span>
            <span>LINE</span>
          </button>
          <button class="kstar-share-btn copy" onclick="shareKStarTwin('copy')">
            <span class="btn-icon">ğŸ“‹</span>
            <span>Copy Link</span>
          </button>
        </div>
      </div>

      <!-- See More Matches -->
      <div class="more-twins" id="more-twins" style="display: none;">
        <button class="btn-secondary" onclick="showMoreTwins()">
          âœ¨ See Another K-Star
        </button>
      </div>
    </div>

    <!-- Celebrity Compatibility Check -->
    <div class="section-card">
      <h3>ğŸ’• Celebrity Compatibility</h3>
      <p style="color: var(--text-secondary); margin-bottom: 1rem;">Check your personality compatibility with your favorite celebrity!</p>
      <div class="celebrity-compatibility-cta">
        <button class="btn-compatibility" onclick="openCelebritySelector()">
          ğŸ’˜ Check Compatibility
        </button>
      </div>
    </div>

    <!-- ì„±ê²© ë¶„ì„ -->
    <div class="section-card" id="section-personality">
      <h3>ğŸ¯ Personality</h3>
      <p id="personality-text">Analyzing your personality...</p>
    </div>

    <!-- ì§ì—… & ì—°ì•  -->
    <div class="grid-2">
      <div class="section-card" id="section-career">
        <h3>ğŸ’¼ Career Paths</h3>
        <ul id="career-list">
          <li>Analyzing career potential...</li>
        </ul>
      </div>
      <div class="section-card" id="section-love">
        <h3>ğŸ’• Love & Relationships</h3>
        <p id="love-text">Analyzing love life...</p>
      </div>
    </div>

    <!-- ê°•ì  & ì•½ì  -->
    <div class="grid-2">
      <div class="section-card">
        <h3>ğŸ’ª Your Strength</h3>
        <p id="strength-text">Analyzing strengths...</p>
      </div>
      <div class="section-card">
        <h3>ğŸŒ± Growth Area</h3>
        <p id="weakness-text">Analyzing growth areas...</p>
      </div>
    </div>

    <!-- í–‰ìš´ ìš”ì†Œ -->
    <div class="section-card">
      <h3>ğŸ€ Lucky Elements</h3>
      <div id="lucky-info">
        <p style="color: var(--text-secondary);">Calculating lucky elements...</p>
      </div>
    </div>

    <!-- Extended Day Master Interpretation -->
    <div class="section-card" id="extended-personality">
      <h3>ğŸŒŸ My Day Master Personality</h3>
      <div id="day-master-details">
        <p style="color: var(--text-secondary);">Analyzing Day Master...</p>
      </div>
    </div>

    <!-- K-Star Curated Items -->
    <div class="affiliate-banner" id="affiliate-banner" style="display: none;">
      <h4 id="affiliate-title"></h4>
      <p id="affiliate-desc"></p>
      <div class="affiliate-products" id="affiliate-products"></div>
      <p class="affiliate-disclaimer" id="affiliate-disclaimer"></p>
    </div>

    <!-- ì•¡ì…˜ ë²„íŠ¼ -->
    <div class="action-buttons">
      <button class="btn-primary" onclick="shareResult()" style="width: auto;">
        ğŸ“¤ Share Result
      </button>
      <a href="compatibility.html" class="btn-secondary">
        ğŸ’• Check Compatibility
      </a>
      <a href="index.html" class="btn-secondary">
        â­ New Analysis
      </a>
    </div>
  </main>

  <!-- SNS ê³µìœ  ëª¨ë‹¬ -->
  <div class="share-modal" id="share-modal" onclick="if(event.target === this) closeShareModal()">
    <div class="share-modal-content">
      <button class="share-modal-close" onclick="closeShareModal()" aria-label="Close">&times;</button>
      <h3>ğŸ“¤ Share Your Result</h3>
      <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Share your personality analysis with friends!</p>

      <div class="share-grid">
        <!-- Twitter/X -->
        <button class="share-btn share-twitter" onclick="shareToSNS('twitter')">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
          <span>X / Twitter</span>
        </button>

        <!-- Facebook -->
        <button class="share-btn share-facebook" onclick="shareToSNS('facebook')">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
          </svg>
          <span>Facebook</span>
        </button>

        <!-- WhatsApp -->
        <button class="share-btn share-whatsapp" onclick="shareToSNS('whatsapp')">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
          </svg>
          <span>WhatsApp</span>
        </button>

        <!-- Telegram -->
        <button class="share-btn share-telegram" onclick="shareToSNS('telegram')">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
          </svg>
          <span>Telegram</span>
        </button>

        <!-- Reddit -->
        <button class="share-btn share-reddit" onclick="shareToSNS('reddit')">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
          </svg>
          <span>Reddit</span>
        </button>

        <!-- LinkedIn -->
        <button class="share-btn share-linkedin" onclick="shareToSNS('linkedin')">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
          </svg>
          <span>LinkedIn</span>
        </button>

        <!-- Threads -->
        <button class="share-btn share-threads" onclick="shareToSNS('threads')">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M12.186 24h-.007c-3.581-.024-6.334-1.205-8.184-3.509C2.35 18.44 1.5 15.586 1.472 12.01v-.017c.03-3.579.879-6.43 2.525-8.482C5.845 1.205 8.6.024 12.18 0h.014c2.746.02 5.043.725 6.826 2.098 1.677 1.29 2.858 3.13 3.509 5.467l-2.04.569c-1.104-3.96-3.898-5.984-8.304-6.015-2.91.022-5.11.936-6.54 2.717C4.307 6.504 3.616 8.914 3.589 12c.027 3.086.718 5.496 2.057 7.164 1.43 1.783 3.631 2.698 6.54 2.717 2.623-.02 4.358-.631 5.8-2.045 1.647-1.613 1.618-3.593 1.09-4.798-.31-.71-.873-1.3-1.634-1.75-.192 1.352-.622 2.446-1.284 3.272-.886 1.102-2.14 1.704-3.73 1.79-1.202.065-2.361-.218-3.259-.801-1.063-.689-1.685-1.74-1.752-2.96-.065-1.182.408-2.256 1.33-3.022.88-.73 2.108-1.146 3.456-1.17 1.005-.018 1.96.14 2.836.468-.034-1.248-.293-2.186-.773-2.8-.545-.7-1.39-1.058-2.512-1.066h-.026c-.907 0-1.68.265-2.3.788l-1.32-1.57c.92-.773 2.122-1.18 3.594-1.213h.041c1.704.02 3.052.593 4.01 1.703.909 1.053 1.386 2.578 1.42 4.536.263.128.513.268.748.42 1.153.747 2.014 1.738 2.491 2.87.706 1.676.763 4.418-1.426 6.563-1.878 1.842-4.232 2.639-7.403 2.665z"/>
          </svg>
          <span>Threads</span>
        </button>

        <!-- KakaoTalk -->
        <button class="share-btn share-kakao" onclick="shareToSNS('kakaotalk')">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M12 3c5.799 0 10.5 3.664 10.5 8.185 0 4.52-4.701 8.184-10.5 8.184a13.5 13.5 0 0 1-1.727-.11l-4.408 2.883c-.501.265-.678.236-.472-.413l.892-3.678c-2.88-1.46-4.785-3.99-4.785-6.866C1.5 6.665 6.201 3 12 3zm5.907 8.06l1.47-1.424a.472.472 0 0 0-.656-.678l-1.928 1.866V9.282a.472.472 0 0 0-.944 0v2.557a.471.471 0 0 0 0 .222V13.5a.472.472 0 0 0 .944 0v-1.363l.427-.413 1.428 2.033a.472.472 0 1 0 .773-.543l-1.514-2.155zm-2.958 1.924h-1.46V9.297a.472.472 0 0 0-.943 0v4.159c0 .26.21.472.471.472h1.932a.472.472 0 1 0 0-.944zm-5.857-1.092l.696-1.707.638 1.707H9.092zm2.523.488l.002-.016a.469.469 0 0 0-.127-.32l-1.618-4.019a.472.472 0 0 0-.882.009l-1.54 3.994a.472.472 0 0 0 .874.358l.334-.866h1.893l.334.866a.472.472 0 0 0 .882-.089l-.152.083zm-4.968-.576h-.473V9.297a.472.472 0 0 0-.944 0v4.159c0 .26.21.472.472.472h.944a.472.472 0 1 0 0-.944z"/>
          </svg>
          <span>KakaoTalk</span>
        </button>

        <!-- LINE -->
        <button class="share-btn share-line" onclick="shareToSNS('line')">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
          </svg>
          <span>LINE</span>
        </button>

        <!-- Pinterest -->
        <button class="share-btn share-pinterest" onclick="shareToSNS('pinterest')">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M12.017 0C5.396 0 .029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.162-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024 0 1.518.769 1.518 1.688 0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128 0 3.768-2.245 3.768-5.487 0-2.861-2.063-4.869-5.008-4.869-3.41 0-5.409 2.562-5.409 5.199 0 1.033.394 2.143.889 2.741.099.12.112.225.085.345-.09.375-.293 1.199-.334 1.363-.053.225-.172.271-.401.165-1.495-.69-2.433-2.878-2.433-4.646 0-3.776 2.748-7.252 7.92-7.252 4.158 0 7.392 2.967 7.392 6.923 0 4.135-2.607 7.462-6.233 7.462-1.214 0-2.354-.629-2.758-1.379l-.749 2.848c-.269 1.045-1.004 2.352-1.498 3.146 1.123.345 2.306.535 3.55.535 6.607 0 11.985-5.365 11.985-11.987C23.97 5.39 18.592.026 11.985.026L12.017 0z"/>
          </svg>
          <span>Pinterest</span>
        </button>

        <!-- Copy Link -->
        <button class="share-btn share-copy" onclick="shareToSNS('copy')">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
          </svg>
          <span>Copy Link</span>
        </button>

        <!-- Native Share (ëª¨ë°”ì¼) -->
        <button class="share-btn share-native" onclick="shareToSNS('native')" id="native-share-btn" style="display: none;">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/>
          </svg>
          <span>More...</span>
        </button>
      </div>
    </div>
  </div>

  <footer>
    <p>Â© 2026 KStar Match. All rights reserved.</p>
    <p style="margin-top: 0.5rem;">
      <a href="privacy.html" style="color: var(--text-secondary);">Privacy Policy</a> Â·
      <a href="terms.html" style="color: var(--text-secondary);">Terms of Service</a> Â·
      <a href="contact.html" style="color: var(--text-secondary);">Contact</a> Â·
      <a href="faq.html" style="color: var(--text-secondary);">FAQ</a>
    </p>
    <p class="disclaimer">This is for entertainment purposes only. Not a substitute for professional advice.</p>
  </footer>

  <!-- Celebrity Selector Modal -->
  <div class="share-modal" id="celebrity-selector-modal" onclick="if(event.target === this) closeCelebritySelector()">
    <div class="share-modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
      <button class="share-modal-close" onclick="closeCelebritySelector()" aria-label="Close">&times;</button>
      <h3>ğŸ’˜ Select Your Celebrity Crush</h3>
      <p style="color: var(--text-secondary); margin-bottom: 1rem;">Choose a celebrity to check your romantic compatibility!</p>

      <div class="celebrity-search">
        <input type="text" id="celebrity-search-input" placeholder="ğŸ” Search by name..." oninput="filterCelebrities()">
      </div>

      <div class="celebrity-category-tabs">
        <button class="cat-tab active" onclick="filterByCategory('all')">All</button>
        <button class="cat-tab" onclick="filterByCategory('K-Pop')">K-Pop</button>
        <button class="cat-tab" onclick="filterByCategory('Actor')">Actor</button>
        <button class="cat-tab" onclick="filterByCategory('Singer')">Singer</button>
        <button class="cat-tab" onclick="filterByCategory('Athlete')">Athlete</button>
      </div>

      <div class="celebrity-grid" id="celebrity-grid">
        <!-- Celebrities will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Celebrity Compatibility Result Modal -->
  <div class="share-modal" id="compatibility-result-modal" onclick="if(event.target === this) closeCompatibilityResult()">
    <div class="share-modal-content" style="max-width: 500px;">
      <button class="share-modal-close" onclick="closeCompatibilityResult()" aria-label="Close">&times;</button>

      <div class="compatibility-header" id="compatibility-header">
        <!-- Header will be populated by JavaScript -->
      </div>

      <div class="compatibility-score-main" id="compatibility-score-main">
        <!-- Main score will be populated -->
      </div>

      <div class="compatibility-details" id="compatibility-details">
        <!-- Score details -->
      </div>

      <div class="compatibility-ai-analysis" id="compatibility-ai-analysis" style="display:none;">
        <!-- GPT AI analysis will be populated -->
      </div>

      <div class="compatibility-actions">
        <button class="btn-secondary" onclick="openCelebritySelector()">
          ğŸ’• Try Another Celebrity
        </button>
        <button class="btn-primary" onclick="shareCompatibility()">
          ğŸ“¤ Share Result
        </button>
      </div>
    </div>
  </div>

  <!-- Discover Paywall Overlay -->
  <div id="discover-paywall" style="display: none;">
    <div class="card" style="max-width: 480px; margin: 1rem; text-align: center;">
      <div style="font-size: 3rem; margin-bottom: 0.5rem;">â­</div>
      <h2>Unlock Your Full Personality Profile</h2>
      <p style="color: var(--text-secondary); margin: 1rem 0;">Your analysis is ready! Unlock your complete personality profile with K-Star match.</p>
      <ul style="text-align: left; margin: 1.5rem 0; list-style: none; padding: 0;">
        <li style="margin-bottom: 0.5rem;">âœ… Four Pillars & Five Elements analysis</li>
        <li style="margin-bottom: 0.5rem;">âœ… Your K-Star Personality Twin</li>
        <li style="margin-bottom: 0.5rem;">âœ… Career, Love & Relationship insights</li>
        <li style="margin-bottom: 0.5rem;">âœ… Strengths & Growth areas</li>
        <li style="margin-bottom: 0.5rem;">âœ… Lucky Elements & Day Master details</li>
        <li>âœ… Celebrity Compatibility check</li>
      </ul>
      <button class="btn-primary" onclick="processDiscoverCheckout()" id="discover-checkout-btn" style="width: 100%; margin-bottom: 0.5rem;">
        â­ Unlock â€” $2.99 One-time
      </button>
      <button class="btn-secondary" onclick="window.location.href='index.html'" style="width: 100%; background: transparent; border: 1px solid var(--border);">
        Back to Home
      </button>
      <p style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 1rem;">One-time payment. No subscription.</p>
    </div>
  </div>

  <!-- Polar Checkout Embed -->
  <script defer src="https://cdn.jsdelivr.net/npm/@polar-sh/checkout@latest/dist/embed.global.js"></script>

  <script src="js/i18n.js"></script>
  <script src="js/saju.js"></script>
  <script src="js/celebrities.js"></script>
  <script src="js/day-master-details.js"></script>
  <script src="js/config.js"></script>
  <script src="js/gpt-fortune.js"></script>
  <script src="js/app.js"></script>
  <script>
    let sajuResult = null;

    // ê²°ê³¼ í˜ì´ì§€ ì´ˆê¸°í™” with error handling
    document.addEventListener('DOMContentLoaded', function() {
      initializeTheme();

      // 2ì´ˆ í›„ ë¡œë”© ì™„ë£Œ (ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„)
      setTimeout(function() {
        try {
          initializeResultPage();
          // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
          document.getElementById('loading-overlay').classList.add('hidden');

          // Payment gate: check if discover is purchased
          if (typeof KStarConfig !== 'undefined' && !KStarConfig.hasPurchased('basic')) {
            document.getElementById('discover-paywall').style.display = 'flex';
          } else {
            // Focus íŒŒë¼ë¯¸í„° í™•ì¸ â†’ í•´ë‹¹ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤ + í•˜ì´ë¼ì´íŠ¸
            const focusParam = new URLSearchParams(window.location.search).get('focus');
            if (focusParam) {
              const focusSection = document.getElementById('section-' + focusParam);
              if (focusSection) {
                setTimeout(function() {
                  focusSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  focusSection.classList.add('section-highlight');
                  setTimeout(function() {
                    focusSection.classList.remove('section-highlight');
                  }, 2000);
                }, 300);
              }
            }
          }

        } catch (error) {
          console.error('Error initializing result page:', error);
          document.getElementById('loading-overlay').innerHTML = `
            <div style="text-align: center; padding: 2rem;">
              <p style="color: var(--danger); font-size: 1.2rem;">Oops! Something went wrong.</p>
              <p style="color: var(--text-secondary); margin-top: 1rem;">Please try again with valid birth information.</p>
              <a href="index.html" class="btn-primary" style="display: inline-block; margin-top: 1.5rem; text-decoration: none;">
                â­ Try Again
              </a>
            </div>
          `;
        }
      }, 2000);
    });

    // í™•ì¥ëœ ê²°ê³¼ í˜ì´ì§€ ì´ˆê¸°í™”
    function initializeResultPage() {
      const params = new URLSearchParams(window.location.search);
      const year = parseInt(params.get('year'));
      const month = parseInt(params.get('month'));
      const day = parseInt(params.get('day'));
      const hour = params.get('hour') || null;
      const gender = params.get('gender');

      if (!year || !month || !day || !gender) {
        throw new Error('Missing required parameters');
      }

      // ì‚¬ì£¼ ê³„ì‚°
      sajuResult = Saju.calculate(year, month, day, hour, gender);

      // ê²°ê³¼ í‘œì‹œ
      displayResult(sajuResult, { year, month, day, hour, gender });

      // ğŸŒŸ ì‚¬ì£¼ ìŒë‘¥ì´ ìŠ¤íƒ€ í‘œì‹œ (ë°”ì´ëŸ´ í•µì‹¬)
      displayKStarTwin(sajuResult);

      // í™•ì¥ëœ ì¼ê°„ í•´ì„ í‘œì‹œ
      displayExtendedDayMaster(sajuResult);
    }

    // í™•ì¥ëœ ì¼ê°„ í•´ì„ í‘œì‹œ
    function displayExtendedDayMaster(result) {
      if (typeof DayMasterDetails === 'undefined') return;

      const element = result.dayMaster.element;
      const isYin = result.dayMaster.yin;
      const details = DayMasterDetails.dayMasterDetails[element][isYin];

      if (!details) return;

      const container = document.getElementById('day-master-details');
      container.innerHTML = `
        <div class="nature-title">${details.nature}</div>
        <p class="nature-description">${details.description}</p>

        <div class="traits-grid">
          ${details.coreTraits.map(trait => `<span class="trait-tag">${trait}</span>`).join('')}
        </div>

        <div class="life-theme">
          <strong>ğŸŒŸ Life Theme:</strong> ${details.lifeTheme}
        </div>

        <p class="karma-lesson">
          <strong>ğŸ’« Karma Lesson:</strong> ${details.karmaLesson}
        </p>
      `;
    }

    // Create Polar checkout session via backend API
    async function createCheckout(tier) {
      const res = await fetch(KStarConfig.api.checkoutEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          tier,
          successUrl: window.location.href,
          embedOrigin: window.location.origin
        })
      });
      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        console.error('Checkout API error:', res.status, errData);
        throw new Error(JSON.stringify(errData));
      }
      return res.json();
    }

    // Open Polar checkout (embed or redirect)
    function openCheckout(checkoutUrl, tier, onConfirmed) {
      if (typeof PolarEmbedCheckout !== 'undefined') {
        PolarEmbedCheckout.create(checkoutUrl, {
          theme: KStarConfig.polar.theme,
        }).then(checkout => {
          checkout.addEventListener('confirmed', () => {
            KStarConfig.storePurchase(tier);
            if (onConfirmed) onConfirmed();
          });
        }).catch(err => {
          console.error('Embed checkout error:', err);
          window.open(checkoutUrl, '_blank');
        });
      } else {
        window.open(checkoutUrl, '_blank');
      }
    }

    // Purchase Discover (main analysis) via Polar
    async function processDiscoverCheckout() {
      const btn = document.getElementById('discover-checkout-btn');
      btn.disabled = true;
      btn.textContent = 'Processing...';

      try {
        const data = await createCheckout('basic');
        if (!data.checkoutUrl) throw new Error('No checkout URL');
        openCheckout(data.checkoutUrl, 'basic', () => {
          document.getElementById('discover-paywall').style.display = 'none';
        });
      } catch (err) {
        console.error('Checkout error:', err);
        alert('Checkout error: ' + err.message);
      }

      btn.disabled = false;
      btn.textContent = 'â­ Unlock â€” $2.99 One-time';

      if (typeof gtag !== 'undefined') {
        gtag('event', 'begin_checkout', {
          'event_category': 'Purchase',
          'event_label': 'discover_analysis',
          'value': 2.99
        });
      }
    }

    // Purchase Compatibility AI via Polar
    async function purchaseCompatibilityAnalysis() {
      try {
        const data = await createCheckout('compatibility');
        if (!data.checkoutUrl) throw new Error('No checkout URL');
        openCheckout(data.checkoutUrl, 'compatibility', () => {
          if (selectedCelebrity && sajuResult) {
            const compat = Celebrities.calculateCelebrityCompatibility(sajuResult.dayMaster, selectedCelebrity);
            loadGPTCompatibility(selectedCelebrity, compat);
          }
        });
      } catch (err) {
        console.error('Checkout error:', err);
        alert('Payment system is being set up. Please try again soon!');
      }

      if (typeof gtag !== 'undefined') {
        gtag('event', 'begin_checkout', {
          'event_category': 'Purchase',
          'event_label': 'compatibility_ai',
          'value': 0.99
        });
      }
    }

    // ============================================
    // ğŸŒŸ K-Star Personality Twin Functions
    // ============================================
    let currentTwinMatch = null;
    let allTwinMatches = [];

    function displayKStarTwin(sajuResult) {
      const card = document.getElementById('kstar-twin-card');
      const shareButtons = document.getElementById('kstar-share-buttons');
      const moreTwins = document.getElementById('more-twins');

      // Find best twins
      allTwinMatches = Celebrities.findBestTwin({
        dayMaster: sajuResult.dayMaster,
        birthYear: parseInt(new URLSearchParams(window.location.search).get('year'))
      }, 5);

      if (allTwinMatches.length === 0) {
        card.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No K-Star Twin found.</p>';
        return;
      }

      currentTwinMatch = allTwinMatches[0];
      renderTwinCard(currentTwinMatch);

      // Show share buttons and more twins
      shareButtons.style.display = 'block';
      if (allTwinMatches.length > 1) {
        moreTwins.style.display = 'block';
      }

      // GA Event
      if (typeof gtag !== 'undefined') {
        gtag('event', 'kstar_twin_found', {
          'event_category': 'Engagement',
          'event_label': currentTwinMatch.celebrity.name,
          'value': currentTwinMatch.score
        });
      }
    }

    function renderTwinCard(match) {
      const card = document.getElementById('kstar-twin-card');
      const celeb = match.celebrity;
      const stars = 'â­'.repeat(match.grade.stars);
      const message = Celebrities.getTwinMessage(celeb.stem, match.score);

      // Category labels
      const categoryLabel = {
        'K-Pop': 'K-Pop Idol',
        'Actor': 'Actor',
        'Singer': 'Singer',
        'Athlete': 'Athlete',
        'Tech': 'Tech Entrepreneur',
        'President': 'Politician',
        'Media': 'Media',
        'Investor': 'Investor',
        'Scientist': 'Scientist'
      };

      // Detail messages
      const detailMessages = match.details.map(d => d.message);

      // Avatar colors
      const avatarColors = Celebrities.avatarColors || {};
      const catColor = avatarColors[celeb.category] || { bg: '8B5CF6', color: 'fff' };
      const initials = celeb.initials || celeb.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

      // Score ring gradient
      const scoreGradient = match.score >= 80 ? '#8b5cf6, #ec4899' : match.score >= 60 ? '#f59e0b, #22c55e' : '#ef4444, #f59e0b';

      card.innerHTML = `
        <div class="twin-result" id="twin-result-capture">
          <div class="twin-avatar-wrapper">
            <div class="twin-avatar-ring" style="background: conic-gradient(#8b5cf6, #ec4899, #8b5cf6);">
              <div class="twin-avatar" style="background: #${catColor.bg}; color: #${catColor.color};">
                ${initials}
              </div>
            </div>
            <div class="twin-avatar-glow" style="background: #${catColor.bg};"></div>
          </div>

          <div class="twin-celebrity-name">${celeb.name}</div>
          <div class="twin-celebrity-korean">${celeb.korean || ''}</div>
          <span class="twin-celebrity-group">
            <span class="twin-cat-dot" style="background: #${catColor.bg};"></span>
            ${categoryLabel[celeb.category] || celeb.category}
          </span>

          <div class="twin-score-ring-container">
            <svg class="twin-score-ring" viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="52" fill="none" stroke="var(--border)" stroke-width="8" opacity="0.3"/>
              <circle cx="60" cy="60" r="52" fill="none"
                stroke="url(#twin-score-grad)" stroke-width="8" stroke-linecap="round"
                stroke-dasharray="${(match.score / 100) * 327} 327"
                transform="rotate(-90 60 60)"
                style="transition: stroke-dasharray 1s ease;"/>
              <defs>
                <linearGradient id="twin-score-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color: ${scoreGradient.split(',')[0]}"/>
                  <stop offset="100%" style="stop-color: ${scoreGradient.split(',')[1] || '#ec4899'}"/>
                </linearGradient>
              </defs>
            </svg>
            <div class="twin-score-inner">
              <span class="twin-score-number">${match.score}</span>
              <span class="twin-score-pct">%</span>
            </div>
          </div>

          <div class="twin-stars">${stars}</div>
          <div class="twin-grade">${match.grade.emoji} ${match.grade.labelEn || match.grade.label}</div>

          <div class="twin-details">
            ${detailMessages.map(d => `<span class="twin-detail-tag">${d}</span>`).join('')}
          </div>

          <div class="twin-message">
            "${message}"
          </div>

          <div class="twin-watermark">kfortunes.com</div>
        </div>
      `;
    }

    let currentTwinIndex = 0;
    function showMoreTwins() {
      currentTwinIndex = (currentTwinIndex + 1) % allTwinMatches.length;
      currentTwinMatch = allTwinMatches[currentTwinIndex];
      renderTwinCard(currentTwinMatch);

      // Scroll to section
      document.getElementById('kstar-twin-section').scrollIntoView({ behavior: 'smooth' });

      // GA Event
      if (typeof gtag !== 'undefined') {
        gtag('event', 'show_more_twins', {
          'event_category': 'Engagement',
          'event_label': currentTwinMatch.celebrity.name
        });
      }
    }

    function shareKStarTwin(platform) {
      if (!currentTwinMatch) return;

      const celeb = currentTwinMatch.celebrity;
      const score = currentTwinMatch.score;
      const grade = currentTwinMatch.grade;
      const url = window.location.href;

      const shareText = `ğŸŒŸ My K-Star Personality Twin is ${celeb.name}!\n\nâ­ Match Score: ${score}%\n${grade.emoji} ${grade.labelEn || grade.label}\n\nFind yours ğŸ‘‰ ${url}\n\n#KStarMatch #KStar #${celeb.name.replace(/\s/g, '')}`;

      switch(platform) {
        case 'twitter':
          window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(url)}`, '_blank', 'width=550,height=420');
          break;

        case 'facebook':
          window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(shareText)}`, '_blank', 'width=550,height=420');
          break;

        case 'whatsapp':
          window.open(`https://wa.me/?text=${encodeURIComponent(shareText)}`, '_blank');
          break;

        case 'telegram':
          window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(shareText)}`, '_blank');
          break;

        case 'line':
          window.open(`https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(url)}&text=${encodeURIComponent(shareText)}`, '_blank');
          break;

        case 'copy':
          copyToClipboard(shareText);
          break;

        default:
          if (navigator.share) {
            navigator.share({
              title: 'KStar Match - My K-Star Personality Twin',
              text: shareText,
              url: url
            }).catch(console.error);
          }
      }

      // GA Event
      if (typeof gtag !== 'undefined') {
        gtag('event', 'share_kstar_twin', {
          'event_category': 'Sharing',
          'event_label': `${platform}_${celeb.name}`,
          'value': score
        });
      }
    }

    // Save twin card as image using html2canvas
    async function saveKStarTwinAsImage() {
      const captureEl = document.getElementById('twin-result-capture');
      if (!captureEl) return;

      // Show loading
      const btn = document.querySelector('.btn-save-image');
      const originalText = btn.textContent;
      btn.textContent = 'Generating...';
      btn.disabled = true;

      try {
        // Dynamically load html2canvas if not already loaded
        if (typeof html2canvas === 'undefined') {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }

        const canvas = await html2canvas(captureEl, {
          backgroundColor: '#1a1a2e',
          scale: 2,
          useCORS: true,
          logging: false
        });

        // Download
        const link = document.createElement('a');
        link.download = `kstar-match-${currentTwinMatch.celebrity.name.replace(/\s/g, '-')}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();

        // GA Event
        if (typeof gtag !== 'undefined') {
          gtag('event', 'save_twin_image', {
            'event_category': 'Sharing',
            'event_label': currentTwinMatch.celebrity.name
          });
        }

        // Toast
        const toast = document.createElement('div');
        toast.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--success); color: white; padding: 1rem 2rem; border-radius: 10px; z-index: 10000; font-weight: 600;';
        toast.textContent = 'Image saved!';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
      } catch (err) {
        console.error('Failed to save image:', err);
        const toast = document.createElement('div');
        toast.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--fire); color: white; padding: 1rem 2rem; border-radius: 10px; z-index: 10000; font-weight: 600;';
        toast.textContent = 'Failed to save image. Try a screenshot instead.';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        // Show toast
        const toast = document.createElement('div');
        toast.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--success); color: white; padding: 1rem 2rem; border-radius: 10px; z-index: 10000; font-weight: 600;';
        toast.textContent = 'ğŸ“‹ Copied to clipboard!';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
      }).catch(console.error);
    }

    // ìœ ëª…ì¸ ë§¤ì¹˜ í‘œì‹œ (ê°œì„ ëœ ë²„ì „)
    function displayCelebrityMatches(dayMaster) {
      const container = document.getElementById('celebrity-matches');
      const matches = Celebrities.getRandomMatch(dayMaster, 2);

      if (matches.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary);">No celebrity matches found.</p>';
        return;
      }

      container.innerHTML = matches.map(celeb => {
        const matchType = Celebrities.getMatchType(celeb, dayMaster);
        const catColor = (Celebrities.avatarColors || {})[celeb.category] || { bg: '8B5CF6', color: 'fff' };
        const initials = celeb.initials || celeb.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        return `
          <div class="celebrity-match">
            <div class="celebrity-avatar" style="background: #${catColor.bg}; color: #${catColor.color};">${initials}</div>
            <div class="celebrity-info">
              <div class="celebrity-name">${celeb.name}</div>
              <div class="celebrity-korean">${celeb.korean}</div>
              <span class="celebrity-category">${celeb.category}</span>
              <span class="match-type-badge" title="${matchType.label}">${matchType.emoji}</span>
            </div>
          </div>
        `;
      }).join('');

      // ë§¤ì¹˜ ë©”ì‹œì§€ ì¶”ê°€
      const message = Celebrities.getMatchMessage(matches[0], dayMaster);
      container.innerHTML += `<div class="match-message">${message}</div>`;
    }
  </script>
  <style>
    .match-type-badge {
      margin-left: 0.5rem;
      font-size: 1rem;
    }

    .celebrity-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: 800;
      letter-spacing: 1px;
      flex-shrink: 0;
    }

    /* ============================================ */
    /* ğŸŒŸ K-Star Personality Twin Styles */
    /* ============================================ */
    .kstar-twin-section {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(236, 72, 153, 0.15));
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      border: 2px solid rgba(139, 92, 246, 0.3);
      position: relative;
      overflow: hidden;
    }

    .kstar-twin-section::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 50%);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0%, 100% { transform: rotate(0deg); }
      50% { transform: rotate(180deg); }
    }

    .kstar-twin-badge {
      display: inline-block;
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      margin-bottom: 1rem;
      position: relative;
      z-index: 1;
    }

    .kstar-twin-title {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .kstar-twin-card {
      background: var(--bg-primary);
      border-radius: 20px;
      padding: 1.5rem;
      position: relative;
      z-index: 1;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2), 0 0 60px rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.2);
    }

    .twin-loading {
      text-align: center;
      padding: 2rem;
    }

    .twin-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    .twin-result {
      text-align: center;
      padding: 1rem 0;
    }

    /* Avatar System */
    .twin-avatar-wrapper {
      position: relative;
      display: inline-block;
      margin-bottom: 1.25rem;
    }

    .twin-avatar-ring {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px;
      animation: avatarPulse 2.5s ease-in-out infinite;
    }

    .twin-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2rem;
      font-weight: 800;
      letter-spacing: 2px;
      border: 3px solid var(--bg-primary);
    }

    .twin-avatar-glow {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 130px;
      height: 130px;
      border-radius: 50%;
      opacity: 0.25;
      filter: blur(25px);
      z-index: -1;
      animation: glowPulse 3s ease-in-out infinite;
    }

    @keyframes avatarPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.04); }
    }

    @keyframes glowPulse {
      0%, 100% { opacity: 0.2; transform: translate(-50%, -50%) scale(1); }
      50% { opacity: 0.4; transform: translate(-50%, -50%) scale(1.15); }
    }

    .twin-celebrity-name {
      font-size: 1.8rem;
      font-weight: 800;
      margin-bottom: 0.2rem;
      background: linear-gradient(135deg, var(--text-primary), var(--accent-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .twin-celebrity-korean {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }

    .twin-celebrity-group {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      background: rgba(139, 92, 246, 0.15);
      padding: 0.3rem 0.85rem;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent-light);
      margin-bottom: 1.25rem;
    }

    .twin-cat-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    /* Score Ring */
    .twin-score-ring-container {
      position: relative;
      width: 130px;
      height: 130px;
      margin: 0.5rem auto 0.75rem;
    }

    .twin-score-ring {
      width: 100%;
      height: 100%;
    }

    .twin-score-inner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .twin-score-number {
      font-size: 2.4rem;
      font-weight: 900;
      background: linear-gradient(135deg, #8b5cf6, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1;
    }

    .twin-score-pct {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-secondary);
    }

    .twin-stars {
      font-size: 1.3rem;
      letter-spacing: 2px;
      margin-bottom: 0.5rem;
    }

    .twin-grade {
      display: inline-block;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #1a1a2e;
      padding: 0.4rem 1rem;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.85rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    }

    .twin-details {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin: 0.75rem 0;
    }

    .twin-detail-tag {
      background: var(--bg-secondary);
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.78rem;
      color: var(--accent-light);
      border: 1px solid var(--border);
    }

    .twin-message {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(236, 72, 153, 0.08));
      padding: 1rem;
      border-radius: 12px;
      font-size: 0.92rem;
      line-height: 1.6;
      color: var(--text-secondary);
      border-left: 3px solid var(--accent);
      margin-top: 1rem;
      font-style: italic;
    }

    .twin-watermark {
      margin-top: 1rem;
      font-size: 0.7rem;
      color: var(--text-secondary);
      opacity: 0.5;
      letter-spacing: 1px;
    }

    /* Save as Image Button */
    .btn-save-image {
      display: block;
      width: 100%;
      padding: 0.85rem;
      margin-bottom: 1rem;
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      z-index: 1;
    }

    .btn-save-image:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
    }

    .btn-save-image:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Share Buttons */
    .kstar-share-buttons {
      margin-top: 1.5rem;
      position: relative;
      z-index: 1;
    }

    .share-prompt {
      text-align: center;
      font-weight: 600;
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }

    .share-btn-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
    }

    .kstar-share-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      padding: 0.75rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
      transition: all 0.2s;
    }

    .kstar-share-btn .btn-icon {
      font-size: 1.5rem;
    }

    .kstar-share-btn.twitter {
      background: #000;
      color: white;
    }

    .kstar-share-btn.facebook {
      background: #1877F2;
      color: white;
    }

    .kstar-share-btn.whatsapp {
      background: #25D366;
      color: white;
    }

    .kstar-share-btn.telegram {
      background: #0088cc;
      color: white;
    }

    .kstar-share-btn.line {
      background: #00B900;
      color: white;
    }

    .kstar-share-btn.copy {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .kstar-share-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .more-twins {
      text-align: center;
      margin-top: 1rem;
      position: relative;
      z-index: 1;
    }

    @media (max-width: 768px) {
      .kstar-twin-section {
        padding: 1.5rem;
      }

      .twin-avatar-ring {
        width: 90px;
        height: 90px;
      }

      .twin-avatar {
        width: 80px;
        height: 80px;
        font-size: 1.8rem;
      }

      .twin-avatar-glow {
        width: 110px;
        height: 110px;
      }

      .twin-celebrity-name {
        font-size: 1.4rem;
      }

      .twin-score-ring-container {
        width: 110px;
        height: 110px;
      }

      .twin-score-number {
        font-size: 2rem;
      }

      .share-btn-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .kstar-share-btn {
        flex-direction: row;
        gap: 0.5rem;
      }
    }

    /* Celebrity Compatibility Styles */
    .celebrity-compatibility-cta {
      margin-top: 1.5rem;
      padding: 1rem;
      background: linear-gradient(135deg, rgba(236, 72, 153, 0.1), rgba(139, 92, 246, 0.1));
      border-radius: 12px;
      text-align: center;
      border: 1px dashed var(--accent-pink);
    }

    .btn-compatibility {
      background: linear-gradient(135deg, #ec4899, #8b5cf6);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 25px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-compatibility:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(236, 72, 153, 0.4);
    }

    .btn-purchase {
      display: inline-block;
      padding: 0.9rem 2rem;
      background: linear-gradient(135deg, #8B5CF6, #EC4899);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      letter-spacing: 0.02em;
    }

    .btn-purchase:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(139, 92, 246, 0.4);
    }

    .celebrity-search {
      margin-bottom: 1rem;
    }

    .celebrity-search input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: 12px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 1rem;
    }

    .celebrity-search input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .celebrity-category-tabs {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .cat-tab {
      padding: 0.4rem 0.8rem;
      border: 1px solid var(--border);
      border-radius: 20px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .cat-tab.active, .cat-tab:hover {
      background: linear-gradient(135deg, var(--accent), var(--accent-pink));
      color: white;
      border-color: transparent;
    }

    .celebrity-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
      max-height: 400px;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .celebrity-select-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .celebrity-select-card:hover {
      transform: translateY(-3px);
      border-color: var(--accent);
      box-shadow: 0 5px 15px rgba(139, 92, 246, 0.2);
    }

    .celebrity-select-card .celeb-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .celebrity-select-card .celeb-name {
      font-weight: 600;
      font-size: 0.9rem;
      text-align: center;
    }

    .celebrity-select-card .celeb-korean {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    /* Compatibility Result Styles */
    .compatibility-header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .compatibility-header .celeb-large-icon {
      font-size: 4rem;
      display: block;
      margin-bottom: 0.5rem;
    }

    .compatibility-header h3 {
      margin: 0.5rem 0 0.25rem;
    }

    .compatibility-score-main {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .score-circle {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: conic-gradient(
        var(--accent) calc(var(--score) * 1%),
        var(--bg-secondary) 0
      );
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      position: relative;
    }

    .score-circle::before {
      content: '';
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: var(--bg-primary);
      position: absolute;
    }

    .score-number {
      position: relative;
      font-size: 2.5rem;
      font-weight: bold;
      background: linear-gradient(135deg, var(--accent), var(--accent-pink));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .score-label {
      font-size: 1.1rem;
      color: var(--text-secondary);
    }

    .compatibility-details {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .detail-item {
      text-align: center;
      padding: 0.75rem;
      background: var(--bg-secondary);
      border-radius: 12px;
    }

    .detail-item .detail-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .detail-item .detail-value {
      font-size: 1.25rem;
      font-weight: bold;
      color: var(--accent-light);
    }


    .blurred-analysis {
      background: var(--bg-secondary);
      padding: 1rem;
      border-radius: 12px;
    }

    .blurred-analysis h4 {
      margin-bottom: 0.5rem;
    }

    .blurred-analysis ul {
      padding-left: 1.5rem;
      margin: 0.5rem 0;
    }

    .blurred-analysis li {
      margin-bottom: 0.25rem;
    }

    .compatibility-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
    }

    .compatibility-actions button {
      flex: 1;
    }

    @media (max-width: 768px) {
      .celebrity-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .compatibility-details {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
      }

      .detail-item {
        padding: 0.5rem;
      }

      .detail-item .detail-value {
        font-size: 1rem;
      }

      .compatibility-actions {
        flex-direction: column;
      }
    }
  </style>
  <script>
    // Native share button visibility
    if (navigator.share) {
      document.getElementById('native-share-btn').style.display = 'flex';
    }

    // ============================================
    // Celebrity Compatibility Functions
    // ============================================
    let currentCategory = 'all';
    let selectedCelebrity = null;

    function openCelebritySelector() {
      const modal = document.getElementById('celebrity-selector-modal');
      modal.classList.add('show');
      populateCelebrityGrid();

      // GA event
      if (typeof gtag !== 'undefined') {
        gtag('event', 'open_celebrity_selector', {
          'event_category': 'Engagement',
          'event_label': 'Celebrity Compatibility'
        });
      }
    }

    function closeCelebritySelector() {
      document.getElementById('celebrity-selector-modal').classList.remove('show');
    }

    function populateCelebrityGrid() {
      const grid = document.getElementById('celebrity-grid');
      const searchTerm = document.getElementById('celebrity-search-input').value.toLowerCase();

      let filtered = Celebrities.data;

      // Filter by category
      if (currentCategory !== 'all') {
        filtered = filtered.filter(c => c.category === currentCategory);
      }

      // Filter by search
      if (searchTerm) {
        filtered = filtered.filter(c =>
          c.name.toLowerCase().includes(searchTerm) ||
          c.korean.includes(searchTerm)
        );
      }

      grid.innerHTML = filtered.map(celeb => {
        const colors = Celebrities.avatarColors[celeb.category] || { bg: '8B5CF6', color: 'fff' };
        const initials = celeb.initials || celeb.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        return `
        <div class="celebrity-select-card" onclick="selectCelebrity('${celeb.name.replace(/'/g, "\\'")}')">
          <span class="celeb-icon" style="background:#${colors.bg};color:#${colors.color};display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:50%;font-weight:700;font-size:0.85rem;">${initials}</span>
          <span class="celeb-name">${celeb.name}</span>
          <span class="celeb-korean">${celeb.korean}</span>
        </div>`;
      }).join('');
    }

    function filterCelebrities() {
      populateCelebrityGrid();
    }

    function filterByCategory(category) {
      currentCategory = category;

      // Update active tab
      document.querySelectorAll('.cat-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent === category || (category === 'all' && tab.textContent === 'All')) {
          tab.classList.add('active');
        }
      });

      populateCelebrityGrid();
    }

    function selectCelebrity(celebName) {
      if (!sajuResult) return;

      const celebrity = Celebrities.data.find(c => c.name === celebName);
      if (!celebrity) return;

      selectedCelebrity = celebrity;
      closeCelebritySelector();

      // Calculate local compatibility first (instant)
      const compatibility = Celebrities.calculateCelebrityCompatibility(sajuResult.dayMaster, celebrity);
      showCompatibilityResult(celebrity, compatibility);

      // GPT AI analysis: only if purchased
      if (KStarConfig.hasPurchased('compatibility')) {
        loadGPTCompatibility(celebrity, compatibility);
      } else {
        showCompatibilityPaywall();
      }

      // GA event
      if (typeof gtag !== 'undefined') {
        gtag('event', 'check_celebrity_compatibility', {
          'event_category': 'Engagement',
          'event_label': celebName,
          'value': compatibility.overall
        });
      }
    }

    async function loadGPTCompatibility(celebrity, localCompatibility) {
      const aiSection = document.getElementById('compatibility-ai-analysis');
      if (!aiSection) return;

      // Show loading state
      aiSection.style.display = 'block';
      aiSection.innerHTML = `
        <div class="ai-loading" style="text-align:center;padding:1rem;">
          <span class="loading-dots">Analyzing compatibility<span>.</span><span>.</span><span>.</span></span>
        </div>
      `;

      try {
        const params = new URLSearchParams(window.location.search);
        const lang = typeof i18n !== 'undefined' ? i18n.currentLang : 'en';

        const formatPillar = (pillar) => {
          if (!pillar) return { stem: '?', branch: '?', korean: '??' };
          return {
            stem: pillar.stem.hanja,
            branch: pillar.branch.hanja,
            korean: pillar.stem.korean + pillar.branch.korean
          };
        };

        const userSajuData = {
          birthDate: {
            year: parseInt(params.get('year')),
            month: parseInt(params.get('month')),
            day: parseInt(params.get('day')),
            hour: params.get('hour')
          },
          gender: params.get('gender'),
          dayMaster: {
            stem: sajuResult.dayMaster.hanja,
            korean: sajuResult.dayMaster.korean,
            element: sajuResult.dayMaster.element,
            yin: sajuResult.dayMaster.yin
          },
          fourPillars: {
            year: formatPillar(sajuResult.fourPillars.year),
            month: formatPillar(sajuResult.fourPillars.month),
            day: formatPillar(sajuResult.fourPillars.day),
            hour: formatPillar(sajuResult.fourPillars.hour)
          },
          elementBalance: sajuResult.elementCount
        };

        const celebrityData = {
          name: celebrity.name,
          korean: celebrity.korean,
          category: celebrity.category,
          dayMaster: celebrity.dayMaster,
          yin: celebrity.yin,
          stem: celebrity.stem,
          birthYear: celebrity.birthYear
        };

        const response = await fetch('/api/compatibility', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userSajuData, celebrityData, language: lang })
        });

        if (!response.ok) throw new Error('API request failed');

        const data = await response.json();

        if (data.success && data.analysis) {
          displayGPTCompatibility(data.analysis, celebrity);
          // Update the overall score from GPT if available
          if (data.analysis.overallScore) {
            document.getElementById('compatibility-score-main').innerHTML = `
              <div class="score-circle" style="--score: ${data.analysis.overallScore}">
                <span class="score-number">${data.analysis.overallScore}%</span>
              </div>
              <div class="score-label">${localCompatibility.relationDesc}</div>
            `;
          }
        } else {
          aiSection.style.display = 'none';
        }
      } catch (error) {
        console.log('GPT compatibility skipped:', error.message);
        aiSection.style.display = 'none';
      }
    }

    function showCompatibilityPaywall() {
      const aiSection = document.getElementById('compatibility-ai-analysis');
      if (!aiSection) return;
      aiSection.style.display = 'block';
      aiSection.innerHTML = `
        <div style="border-top: 1px solid var(--border); margin-top: 1rem; padding-top: 1rem; text-align: center;">
          <h4 style="margin-bottom: 0.5rem; color: var(--accent-light);">ğŸ”® Want AI-Powered Deep Analysis?</h4>
          <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">Get detailed compatibility insights: romantic chemistry, strengths, challenges, and personalized advice.</p>
          <button class="btn-purchase" onclick="purchaseCompatibilityAnalysis()" style="margin-bottom: 0.5rem;">
            ğŸ”“ Unlock AI Compatibility â€” $0.99
          </button>
          <p style="color: var(--text-secondary); font-size: 0.75rem;">One-time purchase</p>
        </div>
      `;
    }

    function displayGPTCompatibility(analysis, celebrity) {
      const aiSection = document.getElementById('compatibility-ai-analysis');
      if (!aiSection || !analysis) return;

      const toText = (val) => {
        if (!val) return '';
        if (typeof val === 'string') return val;
        if (Array.isArray(val)) return val.join(', ');
        if (typeof val === 'object') return Object.values(val).filter(v => typeof v === 'string').join(' ');
        return String(val);
      };

      const strengthsHtml = Array.isArray(analysis.strengths)
        ? analysis.strengths.map(s => `<li>âœ¨ ${toText(s)}</li>`).join('')
        : `<li>âœ¨ ${toText(analysis.strengths)}</li>`;

      const challengesHtml = Array.isArray(analysis.challenges)
        ? analysis.challenges.map(c => `<li>âš¡ ${toText(c)}</li>`).join('')
        : `<li>âš¡ ${toText(analysis.challenges)}</li>`;

      aiSection.style.display = 'block';
      aiSection.innerHTML = `
        <div style="border-top: 1px solid var(--border); margin-top: 1rem; padding-top: 1rem;">
          <h4 style="margin-bottom: 0.75rem; color: var(--accent-light);">AI Compatibility Analysis</h4>

          ${analysis.dynamics ? `<p style="margin-bottom: 1rem; line-height: 1.6;">${toText(analysis.dynamics)}</p>` : ''}

          <div style="margin-bottom: 1rem;">
            <h5 style="margin-bottom: 0.5rem;">Strengths</h5>
            <ul style="list-style: none; padding: 0; margin: 0;">${strengthsHtml}</ul>
          </div>

          <div style="margin-bottom: 1rem;">
            <h5 style="margin-bottom: 0.5rem;">Challenges</h5>
            <ul style="list-style: none; padding: 0; margin: 0;">${challengesHtml}</ul>
          </div>

          ${analysis.romanticChemistry ? `
          <div style="margin-bottom: 1rem;">
            <h5 style="margin-bottom: 0.5rem;">ğŸ’• Romantic Chemistry</h5>
            <p style="line-height: 1.6;">${toText(analysis.romanticChemistry)}</p>
          </div>` : ''}

          ${analysis.advice ? `
          <div style="margin-bottom: 1rem;">
            <h5 style="margin-bottom: 0.5rem;">ğŸ’¡ Advice</h5>
            <p style="line-height: 1.6;">${toText(analysis.advice)}</p>
          </div>` : ''}

          ${analysis.luckyDateTip ? `
          <div style="margin-bottom: 0.5rem;">
            <h5 style="margin-bottom: 0.5rem;">ğŸ€ Lucky Timing</h5>
            <p style="line-height: 1.6;">${toText(analysis.luckyDateTip)}</p>
          </div>` : ''}
        </div>
      `;
    }

    function showCompatibilityResult(celebrity, compatibility) {
      const modal = document.getElementById('compatibility-result-modal');

      // Header
      const colors = Celebrities.avatarColors[celebrity.category] || { bg: '8B5CF6', color: 'fff' };
      const initials = celebrity.initials || celebrity.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
      document.getElementById('compatibility-header').innerHTML = `
        <span class="celeb-large-icon" style="background:#${colors.bg};color:#${colors.color};display:inline-flex;align-items:center;justify-content:center;width:60px;height:60px;border-radius:50%;font-weight:700;font-size:1.2rem;margin:0 auto 0.5rem;">${initials}</span>
        <h3>${celebrity.name}</h3>
        <p style="color: var(--text-secondary);">${celebrity.korean} Â· ${celebrity.category}</p>
        <p style="margin-top: 0.5rem; color: var(--accent-light);">${compatibility.matchType.emoji} ${compatibility.matchType.label}</p>
      `;

      // Main score
      document.getElementById('compatibility-score-main').innerHTML = `
        <div class="score-circle" style="--score: ${compatibility.overall}">
          <span class="score-number">${compatibility.overall}%</span>
        </div>
        <div class="score-label">${compatibility.relationDesc}</div>
      `;

      // Detail scores
      document.getElementById('compatibility-details').innerHTML = `
        <div class="detail-item">
          <div class="detail-label">ğŸ§  Personality</div>
          <div class="detail-value">${compatibility.personality}%</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">ğŸ’• Emotional</div>
          <div class="detail-value">${compatibility.emotional}%</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">ğŸ”® Long-term</div>
          <div class="detail-value">${compatibility.longTerm}%</div>
        </div>
      `;

      modal.classList.add('show');
    }

    function closeCompatibilityResult() {
      document.getElementById('compatibility-result-modal').classList.remove('show');
    }

    function shareCompatibility() {
      if (!selectedCelebrity || !sajuResult) return;

      const compatibility = Celebrities.calculateCelebrityCompatibility(sajuResult.dayMaster, selectedCelebrity);
      const text = `ğŸ’˜ My KStar Match Celebrity Compatibility!\n\n` +
        `${selectedCelebrity.name}: ${compatibility.overall}% match!\n` +
        `${compatibility.matchType.emoji} ${compatibility.relationDesc}\n\n` +
        `Check your celebrity compatibility at KStar Match! ğŸ”®`;

      if (navigator.share) {
        navigator.share({
          title: 'KStar Match Celebrity Compatibility',
          text: text,
          url: window.location.href
        }).catch(console.error);
      } else {
        // Fallback to copy
        navigator.clipboard.writeText(text + '\n' + window.location.href)
          .then(() => {
            alert('Copied to clipboard! ğŸ“‹');
          })
          .catch(console.error);
      }

      // GA event
      if (typeof gtag !== 'undefined') {
        gtag('event', 'share_celebrity_compatibility', {
          'event_category': 'Sharing',
          'event_label': selectedCelebrity.name
        });
      }
    }

    // Affiliate products based on language
    function loadAffiliateProducts() {
      const lang = typeof i18n !== 'undefined' ? i18n.currentLang : 'en';
      const container = document.getElementById('affiliate-products');
      const title = document.getElementById('affiliate-title');
      const desc = document.getElementById('affiliate-desc');
      const disclaimer = document.getElementById('affiliate-disclaimer');

      // K-Star themed affiliate products by language
      // TODO: Replace with valid affiliate links
      const affiliateData = {
        ko: {
          title: 'ğŸŒŸ K-Star ì¶”ì²œ ì•„ì´í…œ',
          desc: 'ë‚´ ì„±ê²© ìŠ¤íƒ€ì¼ì— ì–´ìš¸ë¦¬ëŠ” K-Culture ì•„ì´í…œ',
          disclaimer: '',
          products: [
            { name: 'í¬í† ì¹´ë“œ ë°”ì¸ë”', icon: 'ğŸ’œ', price: '', url: '#', desc: 'K-Pop ì½œë ‰ì…˜' },
            { name: 'í•œêµ­ ë·°í‹°ì„¸íŠ¸', icon: 'âœ¨', price: '', url: '#', desc: 'ìŠ¤íƒ€ì˜ í”¼ë¶€ ë¹„ê²°' },
            { name: 'K-Pop ì•¨ë²”', icon: 'ğŸ’¿', price: '', url: '#', desc: 'ìµœì‹  ì•¨ë²” ëª¨ìŒ' },
            { name: 'í•œë³µ ì¸í˜•', icon: 'ğŸ', price: '', url: '#', desc: 'í”„ë¦¬ë¯¸ì—„ í•œêµ­ ì¸í˜•' }
          ]
        },
        en: {
          title: 'ğŸŒŸ K-Star Picks for You',
          desc: 'Curated K-Culture items that match your star energy',
          disclaimer: '',
          products: [
            { name: 'K-Pop Photo Binder', icon: 'ğŸ’œ', price: '', url: '#', desc: 'Photocard Collection' },
            { name: 'Korean Skincare Set', icon: 'âœ¨', price: '', url: '#', desc: 'K-Beauty Glow' },
            { name: 'BTS Photo Book', icon: 'ğŸ“–', price: '', url: '#', desc: 'Special Edition' },
            { name: 'Hanbok Doll', icon: 'ğŸ', price: '', url: '#', desc: 'Korean Traditional' }
          ]
        },
        ja: {
          title: 'ğŸŒŸ K-Star ãŠã™ã™ã‚ã‚¢ã‚¤ãƒ†ãƒ ',
          desc: 'ã‚ãªãŸã®æ˜Ÿã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã«åˆã†K-Cultureã‚¢ã‚¤ãƒ†ãƒ ',
          disclaimer: '',
          products: [
            { name: 'ãƒ•ã‚©ãƒˆã‚«ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒ€ãƒ¼', icon: 'ğŸ’œ', price: '', url: '#', desc: 'K-Popã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³' },
            { name: 'éŸ“å›½ã‚¹ã‚­ãƒ³ã‚±ã‚¢ã‚»ãƒƒãƒˆ', icon: 'âœ¨', price: '', url: '#', desc: 'K-ãƒ“ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ¼' },
            { name: 'BTS ãƒ•ã‚©ãƒˆãƒ–ãƒƒã‚¯', icon: 'ğŸ“–', price: '', url: '#', desc: 'ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³' },
            { name: 'éŸ“æœäººå½¢', icon: 'ğŸ', price: '', url: '#', desc: 'éŸ“å›½ä¼çµ±äººå½¢' }
          ]
        },
        zh: {
          title: 'ğŸŒŸ K-Star ç²¾é€‰å¥½ç‰©',
          desc: 'ä¸ä½ æ˜Ÿåº§èƒ½é‡åŒ¹é…çš„éŸ©æµæ–‡åŒ–ç²¾å“',
          disclaimer: '',
          products: [
            { name: 'å°å¡æ”¶çº³å†Œ', icon: 'ğŸ’œ', price: '', url: '#', desc: 'K-Popæ”¶è—' },
            { name: 'éŸ©å›½æŠ¤è‚¤å¥—è£…', icon: 'âœ¨', price: '', url: '#', desc: 'K-Beauty' },
            { name: 'BTS å†™çœŸé›†', icon: 'ğŸ“–', price: '', url: '#', desc: 'é™é‡ç‰ˆ' },
            { name: 'éŸ©æœå¨ƒå¨ƒ', icon: 'ğŸ', price: '', url: '#', desc: 'éŸ©å›½ä¼ ç»Ÿ' }
          ]
        },
        vi: {
          title: 'ğŸŒŸ K-Star gá»£i Ã½ cho báº¡n',
          desc: 'Sáº£n pháº©m K-Culture phÃ¹ há»£p nÄƒng lÆ°á»£ng sao cá»§a báº¡n',
          disclaimer: '',
          products: [
            { name: 'Album áº£nh K-Pop', icon: 'ğŸ’œ', price: '', url: '#', desc: 'Bá»™ sÆ°u táº­p' },
            { name: 'Skincare HÃ n Quá»‘c', icon: 'âœ¨', price: '', url: '#', desc: 'K-Beauty' },
            { name: 'BTS Photo Book', icon: 'ğŸ“–', price: '', url: '#', desc: 'PhiÃªn báº£n Ä‘áº·c biá»‡t' },
            { name: 'BÃºp bÃª Hanbok', icon: 'ğŸ', price: '', url: '#', desc: 'Truyá»n thá»‘ng HÃ n' }
          ]
        }
      };

      const data = affiliateData[lang] || affiliateData.en;
      const banner = document.getElementById('affiliate-banner');

      // ìƒí’ˆì´ ì—†ìœ¼ë©´ ë°°ë„ˆ ìˆ¨ê¹€
      if (!data.products || data.products.length === 0) {
        banner.style.display = 'none';
        return;
      }

      banner.style.display = 'block';
      title.textContent = data.title;
      desc.textContent = data.desc;
      disclaimer.textContent = data.disclaimer;

      container.innerHTML = data.products.map(product => `
        <a href="${product.url}" class="affiliate-product" target="_blank" rel="noopener sponsored"
           onclick="if(typeof gtag !== 'undefined') gtag('event', 'affiliate_click', {'event_category': 'Monetization', 'event_label': '${product.name}'});">
          <span class="icon">${product.icon}</span>
          <span class="name">${product.name}</span>
          <span class="price">${product.price}</span>
        </a>
      `).join('');
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì œíœ´ ìƒí’ˆ ë¡œë“œ
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(loadAffiliateProducts, 2500); // ê²°ê³¼ ë¡œë”© í›„ í‘œì‹œ
    });
  </script>

  <!-- Userback Feedback Widget -->
  <script>
    window.Userback = window.Userback || {};
    Userback.access_token = "A-dCd3pYRpaT8J3VbfGJYZcGVY9";
    (function(d) {
      var s = d.createElement('script');s.async = true;s.src = 'https://static.userback.io/widget/v1.js';(d.head || d.body).appendChild(s);
    })(document);
  </script>
</body>
</html>
